# æœåŠ¡ç«¯ç¼“å­˜ç³»ç»Ÿ

## æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†æœåŠ¡ç«¯å†…å­˜ç¼“å­˜ç³»ç»Ÿï¼Œç”¨äºç¼“å­˜ Lixinger API çš„å“åº”æ•°æ®ã€‚ç¼“å­˜åœ¨å½“å¤©æœ‰æ•ˆï¼Œæ¬¡æ—¥è‡ªåŠ¨è¿‡æœŸã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **å½“å¤©ç¼“å­˜**ï¼šç¼“å­˜æ•°æ®åœ¨å½“å¤© 23:59:59 ä¹‹å‰æœ‰æ•ˆ
- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šæ¯å°æ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- âœ… **ç¼“å­˜ç®¡ç†**ï¼šæä¾› Web ç•Œé¢å’Œ API æ¥å£ç®¡ç†ç¼“å­˜
- âœ… **æ€§èƒ½æå‡**ï¼šç›¸åŒå‚æ•°çš„è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¯»å–ï¼Œå“åº”é€Ÿåº¦æå‡ 10-100 å€

## æ¶æ„

### 1. ç¼“å­˜å·¥å…·ç±»

**ä½ç½®**ï¼š`src/lib/cache.ts`

```typescript
import { dailyCache, generateCacheKey } from '@/lib/cache';

// è·å–ç¼“å­˜
const data = dailyCache.get<MyData>('my-key');

// è®¾ç½®ç¼“å­˜ï¼ˆå½“å¤©æœ‰æ•ˆï¼‰
dailyCache.set('my-key', myData);

// ç”Ÿæˆç¼“å­˜é”®
const key = generateCacheKey({
  param1: 'value1',
  param2: ['array', 'values'],
});
```

### 2. API é›†æˆ

**ä½ç½®**ï¼š`src/app/api/lixinger/route.ts`

å·²è‡ªåŠ¨é›†æˆç¼“å­˜åŠŸèƒ½ï¼š
- è¯·æ±‚å‰æ£€æŸ¥ç¼“å­˜
- å‘½ä¸­ç¼“å­˜ï¼šç›´æ¥è¿”å›ï¼Œå¹¶æ ‡è®° `fromCache: true`
- æœªå‘½ä¸­ï¼šè¯·æ±‚ API å¹¶ç¼“å­˜ç»“æœ

### 3. ç¼“å­˜ç®¡ç† API

**ä½ç½®**ï¼š`src/app/api/cache/route.ts`

#### è·å–ç¼“å­˜ç»Ÿè®¡

```bash
GET /api/cache

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "stats": {
    "total": 5,
    "valid": 4,
    "expired": 1,
    "entries": [...]
  }
}
```

#### æ¸…é™¤æ‰€æœ‰ç¼“å­˜

```bash
DELETE /api/cache

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "message": "All cache cleared"
}
```

#### æ¸…é™¤æŒ‡å®šç¼“å­˜

```bash
DELETE /api/cache?key=xxx

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "deleted": true
}
```

#### æ‰‹åŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

```bash
POST /api/cache/cleanup

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "message": "Cache cleanup completed",
  "stats": {...}
}
```

### 4. Web ç®¡ç†ç•Œé¢

**ä½ç½®**ï¼š`src/app/cache/page.tsx`

è®¿é—® `/cache` æŸ¥çœ‹å’Œç®¡ç†ç¼“å­˜ï¼š

- ğŸ“Š æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ï¼ˆæ€»æ•°ã€æœ‰æ•ˆã€è¿‡æœŸï¼‰
- ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜æ¡ç›®è¯¦æƒ…
- ğŸ”„ åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
- ğŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜
- ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨

```typescript
import { dailyCache, generateCacheKey } from '@/lib/cache';

export async function GET(request: NextRequest) {
  const params = { stockCode: '000001', years: 10 };
  const cacheKey = generateCacheKey(params);

  // å°è¯•ä»ç¼“å­˜è·å–
  const cached = dailyCache.get(cacheKey);
  if (cached) {
    return NextResponse.json({ ...cached, fromCache: true });
  }

  // è¯·æ±‚æ•°æ®
  const data = await fetchData(params);

  // å­˜å…¥ç¼“å­˜
  dailyCache.set(cacheKey, data);

  return NextResponse.json(data);
}
```

### åœ¨å®¢æˆ·ç«¯æ£€æµ‹ç¼“å­˜

```typescript
const response = await fetch('/api/lixinger', {
  method: 'POST',
  body: JSON.stringify(params),
});

const result = await response.json();

if (result.fromCache) {
  console.log('âœ… æ•°æ®æ¥è‡ªç¼“å­˜');
} else {
  console.log('âŒ æ•°æ®æ¥è‡ª API');
}
```

## ç¼“å­˜ç­–ç•¥

### ç¼“å­˜é”®ç”Ÿæˆè§„åˆ™

```typescript
const cacheKey = generateCacheKey({
  stockCodes: ['000001', '000002'].sort(),  // æ•°ç»„ä¼šè‡ªåŠ¨æ’åº
  years: 10,
  metricsList: ['pe', 'cp'].sort(),
});
```

- å¯¹è±¡çš„é”®ä¼šè‡ªåŠ¨æ’åº
- æ•°ç»„ä¼šè‡ªåŠ¨æ’åº
- ç›¸åŒå‚æ•°ä¿è¯ç”Ÿæˆç›¸åŒçš„ç¼“å­˜é”®

### è¿‡æœŸç­–ç•¥

- **å½“å¤©æœ‰æ•ˆ**ï¼šç¼“å­˜åœ¨å½“å¤© 23:59:59 ä¹‹å‰æœ‰æ•ˆ
- **è‡ªåŠ¨æ¸…ç†**ï¼šæ¯å°æ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜
- **æ‰‹åŠ¨æ¸…é™¤**ï¼šå¯é€šè¿‡ API æˆ– Web ç•Œé¢æ¸…é™¤

## æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| å•æ¬¡è¯·æ±‚ï¼ˆ10å¹´æ•°æ®ï¼‰ | ~2-5s | ~10-50ms | **40-500x** |
| åˆ†æ‰¹è¯·æ±‚ï¼ˆ20å¹´æ•°æ®ï¼‰ | ~10-20s | ~10-50ms | **200-2000x** |
| å¹¶å‘è¯·æ±‚ï¼ˆ4ä¸ªæ•°æ®æºï¼‰ | ~8-20s | ~10-50ms | **160-2000x** |

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼“å­˜æ—¥å¿—

æœåŠ¡ç«¯æ§åˆ¶å°ä¼šè¾“å‡ºç¼“å­˜ç›¸å…³æ—¥å¿—ï¼š

```
âœ… ç¼“å­˜å‘½ä¸­: {"stockCodes":["000300"],"years":10,...}
âŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œè¯·æ±‚ Lixinger API: {"stockCodes":["000300"],...}
ğŸ’¾ æ•°æ®å·²ç¼“å­˜
ğŸ§¹ æ¸…ç†äº† 3 ä¸ªè¿‡æœŸç¼“å­˜
```

### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

è®¿é—® `/cache` é¡µé¢æˆ–è°ƒç”¨ `GET /api/cache` æŸ¥çœ‹ï¼š

- æ€»ç¼“å­˜æ¡ç›®æ•°
- æœ‰æ•ˆç¼“å­˜æ•°
- è¿‡æœŸç¼“å­˜æ•°
- æ¯ä¸ªç¼“å­˜çš„è¯¦ç»†ä¿¡æ¯

## æ³¨æ„äº‹é¡¹

1. **å†…å­˜é™åˆ¶**ï¼šç¼“å­˜å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡å™¨é‡å¯åä¼šä¸¢å¤±
2. **æ•°æ®æ›´æ–°**ï¼šå¦‚éœ€è·å–æœ€æ–°æ•°æ®ï¼Œéœ€æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
3. **å¤šå®ä¾‹éƒ¨ç½²**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶æ¯ä¸ªå®ä¾‹ç‹¬ç«‹ç»´æŠ¤ç¼“å­˜
4. **ç¼“å­˜å¤§å°**ï¼šå»ºè®®ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œå¿…è¦æ—¶æ¸…ç†ç¼“å­˜

## æœªæ¥æ‰©å±•

å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ‰©å±•ï¼š

- [ ] Redis ç¼“å­˜æ”¯æŒï¼ˆæŒä¹…åŒ–ã€åˆ†å¸ƒå¼ï¼‰
- [ ] ç¼“å­˜é¢„çƒ­ï¼ˆå¯åŠ¨æ—¶åŠ è½½å¸¸ç”¨æ•°æ®ï¼‰
- [ ] ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼ˆLRUã€LFUï¼‰
- [ ] ç¼“å­˜å‹ç¼©ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
- [ ] ç¼“å­˜ç»Ÿè®¡å›¾è¡¨ï¼ˆå‘½ä¸­ç‡ã€å¤§å°å˜åŒ–ï¼‰

