# 个股指标功能实现说明

## 概述
在指标页面新增了个股指标功能，支持查看个股的PE TTM和总市值数据。目前已添加23只股票，按行业分组显示。

**重要特性**：采用**按需加载**策略，只在用户选择某只股票时才加载该股票的数据，大大提高了初始加载速度和响应性能。

## 支持的股票列表

### 银行保险证券（6只）
- 中国银行 (601988)
- 招商银行 (600036)
- 成都银行 (601838)
- 杭州银行 (600926)
- 北京银行 (601169)
- 中国平安 (601318)

### 能源行业（6只）
- 中国神华 (601088)
- 中远海控 (601919)
- 紫金矿业 (601899)
- 中国石油 (601857)
- 中国海洋 (600938)
- 中国移动 (600941)

### 消费行业（5只）
- 青岛啤酒 (600600)
- 海天味业 (603288)
- 伊利股份 (600887)
- 珀莱雅 (603605)
- 格力电器 (000651)

### 新能源&汽车（4只）
- 比亚迪 (002594)
- 宇通客车 (600066)
- 宁德时代 (300750)
- 福耀玻璃 (600660)

## 主要改动

### 1. 更新股票配置类型 (`/src/constants/stocks.ts`)
- 在 `StockConfig` 接口中新增 `industry?: string` 字段
- 添加所有23只股票的配置，每个都包含行业信息
- 导出 `ALL_INDIVIDUAL_STOCKS` 数组，包含所有个股配置

### 2. 创建按需加载 Hook (`/src/app/indicators/hooks/useIndividualStockData.ts`) ⭐ 新增
专门用于个股数据的按需加载：
- 只在用户选择某只股票时才加载该股票的数据
- 使用 `useRef` 实现客户端缓存，避免重复请求
- 缓存键包含股票代码和年限，确保数据准确性
- 提供 loading、error 状态和 refetch 功能

### 3. 更新个股展示组件 (`/src/app/indicators/components/IndividualStockDisplay.tsx`)
重构为自主管理数据加载：
- 使用 `useIndividualStockData` hook 按需加载数据
- 支持通过下拉选择器切换股票
- **按行业分组显示股票**（使用 `<optgroup>` 标签）
- 显示加载状态和错误处理
- 展示最新的 PE TTM 和总市值数据
- 展示 PE TTM 和总市值的历史趋势图（双Y轴图表）
- 自动根据市值大小选择单位（亿/万亿）

### 4. 更新数据获取逻辑 (`/src/app/indicators/hooks/useData.ts`)
- 选择"个股指标"时，**不再批量加载所有股票数据**
- 直接返回空数据，由 `IndividualStockDisplay` 组件按需加载
- 减少初始加载时间和API请求次数

## API 使用说明

### 数据源
- API URL: `https://open.lixinger.com/api/cn/company/fundamental/non_financial`
- 这是第一个使用股票类型API的功能

### 请求参数（单个股票）
```typescript
{
  stockCodes: ['601988'],  // 只请求当前选中的股票代码
  codeTypeMap: { '601988': 'stock' },  // 类型映射
  years: 10,  // 查询年限（可调整）
  metricsList: ['pe_ttm', 'mc']  // 指标列表
}
```

### 返回数据结构
```typescript
{
  date: string,      // 日期
  stockCode: string, // 股票代码
  pe_ttm: number,    // 市盈率TTM
  mc: number,        // 总市值（单位：元）
}
```

## 用户界面特性

### 行业分组显示
下拉选择器使用 HTML `<optgroup>` 标签按行业分组：
- 银行保险证券
- 能源行业
- 消费行业
- 新能源&汽车

这样用户可以更方便地找到同行业的股票进行对比分析。

## 扩展性设计

### 添加更多股票
在 `/src/constants/stocks.ts` 中添加新的股票配置：

```typescript
export const NEW_STOCK: StockConfig = {
  code: 'XXXXXX',
  name: '股票名称',
  type: 'stock',
  industry: '行业名称',
};
```

然后将新股票添加到 `ALL_INDIVIDUAL_STOCKS` 数组中：

```typescript
export const ALL_INDIVIDUAL_STOCKS: StockConfig[] = [
  // ... 现有股票
  NEW_STOCK,
];
```

### 添加新行业
只需在股票配置中使用新的 `industry` 值，组件会自动创建新的行业分组。

## 测试建议

1. 访问 `/indicators` 页面
2. 点击"个股指标"按钮
3. 观察加载行为：
   - 初始只加载中国银行的数据（第一只股票）
   - 查看浏览器控制台，应该看到"加载个股数据: 601988"
4. 切换到其他股票（如招商银行）：
   - 第一次切换会看到加载状态
   - 控制台显示"加载个股数据: 600036"
5. 再次切换回中国银行：
   - 应该立即显示，无需等待
   - 控制台显示"使用缓存数据: 601988"
6. 验证数据显示：
   - 最新PE TTM显示
   - 最新总市值显示
   - 历史趋势图正确渲染
7. 测试不同行业的股票切换

## 性能考虑

- ✅ **按需加载**：只在需要时加载单个股票数据
- ✅ **客户端缓存**：已加载的股票数据会被缓存，切换时无需重新请求
- ✅ **服务器缓存**：API 层的每日缓存仍然有效，相同股票的重复请求会从服务器缓存返回
- ✅ **快速响应**：初始加载时间从 ~23 个请求降为 1 个请求

## 注意事项

- 股票数据使用 `pe_ttm`（直接值），而非 `pe_ttm.mcw`（市值加权，用于指数）
- 市值单位自动根据大小切换（<1万亿显示亿，>=1万亿显示万亿）
- 数据缓存机制与其他指标一致（每日缓存）
- 数据源来自 cn_stock.md 文件

